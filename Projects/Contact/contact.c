#include "contact.h"
#include <stdio.h>
#include <string.h>

/*
//???????????
void InitContact(contact* pc)
{
    //??????????????pc??????
    assert(pc); 
    //???pc????????壬????pc->data??peoInfo??????????????飬??????????κ???????????pc->data??
    //???????pc->data???????????????????????????????????????????sizeof(pc->data)?????????????С??????????λ??
    //?????sizeof(pc->data)?滻?DATA_MAX * sizeof(peoInfo)
    //memset(pc->data, 0, DATA_MAX * sizeof(peoInfo)); 
    memset(pc->data, 0, sizeof(pc->data)); 
    //pc->sz?????????????????????0
    pc->sz = 0;
}
*/

//???????????
void InitContact(contact* pc)
{
    assert(pc); 
    pc->capacity = CAPACITY; 
    pc->sz = 0;
    pc->data = (peoInfo *)malloc(pc->capacity * sizeof(peoInfo)); //?????????3????????С
    //??濪????????????????????????????????????ж??????????????б????
    if (pc->data == NULL)  
    {
      perror("InitContact::malloc");
      return;
    }
    //??濪???????????????????????????0
    memset(pc->data, 0, pc->capacity * sizeof(peoInfo));  
}

/*
//?????????
void AddContact(contact *pc)
{
    assert(pc);
    if (pc->sz == DATA_MAX)
    {
      printf("???????");
      return;  //???????????????У???????
    }
    //δ????????????
    printf("????????????");
    scanf("%s", pc->data[pc->sz].name); 
    // ???????pc->sz(С??DATA_MAX)??????????????data?????????±??data[0] ~ data[pc->sz-1]?????????????????data?????????±????pc->sz
    printf("??????????");
    scanf("%d", &pc->data[pc->sz].age);  //pc->data[pc->sz]??????????壬??????????κ?int?????????????pc->data[pc->sz].age
    printf("?????????");
    scanf("%s", pc->data[pc->sz].sex);
    printf("?????????");
    scanf("%s", pc->data[pc->sz].tele);
    printf("??????????");
    scanf("%s", pc->data[pc->sz].address);
    pc->sz++;
    printf("??????\n");    
}
*/
void CheckCapacity(contact *pc)
{
if (pc->sz == pc->capacity)
    {
      peoInfo * tmp = (peoInfo *)realloc(pc->data, (pc->capacity + 2) * sizeof(peoInfo)); //??????????????????????realloc?????????????????2????????
      if (tmp)  //????????tmp????м????????????????????????tmp???????????????????pc->data
      {
        pc->data = tmp;
        pc->capacity += 2;
        printf("????????\n");
      }
      else {
        perror("CheckCapacity:realloc"); //????????????
        return;
      }
    }
}

void AddContact(contact *pc)
{
    assert(pc);
    
    CheckCapacity(pc); //????????????????

    printf("????????????");
    scanf("%s", pc->data[pc->sz].name); 
    // ???????pc->sz(С??DATA_MAX)??????????????data?????????±??data[0] ~ data[pc->sz-1]?????????????????data?????????±????pc->sz
    printf("??????????");
    scanf("%d", &pc->data[pc->sz].age);  //pc->data[pc->sz]??????????壬pc->data[pc->sz].age?????int???????????????????κ?int?????????????pc->data[pc->sz].age
    printf("?????????");
    scanf("%s", pc->data[pc->sz].sex);
    printf("?????????");
    scanf("%s", pc->data[pc->sz].tele);
    printf("??????????");
    scanf("%s", pc->data[pc->sz].address);
    pc->sz++;
    printf("??????\n"); 
}   

//???????????????????????????
void PrintContact(contact* pc)
{
  assert(pc);
  int index;
  printf("%-10s %-5s %-6s %-12s %-15s\n", "????","????","???","?绰","??");
  for (index = 0; index < pc->sz; index++) //sz?????????????????for?????????????????
    printf("%-10s %-5d %-6s %-12s %-15s\n", 
      pc->data[index].name, 
      pc->data[index].age,
      pc->data[index].sex,
      pc->data[index].tele,
      pc->data[index].address); //?ù??????????????????????????????????????????????????
}

//???????????????????????????ж???????????????????????
int Find_Name(contact * pc, char * name)
{
  assert(pc&&name);
  int index;
  for (index = 0; index < pc->sz; index++)
  {
    if (strcmp(pc->data[index].name, name) == 0)
      return index; //???????data??????????±?   
  }
  return -1; //????????-1??-1???κ????data??????????±?0 ~ DATA_MAX-1 ????????
}

//???????????
void DelContact(contact* pc)
{
  assert(pc);
  char name[NAME_MAX];//????????????????

  if(pc->sz == 0) //pc->sz?????????м??????????0???????????????????????ж????????
  {
    printf("???????????????\n");
    return;
  }

  //??????????????????????????pc->sz????0 ~ DATA_MAX?????data??????????±??0 ~ DATA_MAX-1
  printf("?????????????????????");
  scanf("%s", name);
  //????????±?????????-1
  int pos = Find_Name(pc, name);
  if (pos == -1)
    printf("δ????????????????\n");
  else {
    int j = 0;
    for (j = pos; j < pc->sz-1; j++) //??????j <= pc->sz-2
    {
      //???????????±?????ú??????????????????????????????????????????????????????????
      //????????????鲻?????????j+1????????999????j????????998??pc->sz-1=999??j<pc->sz-1??????j?????998
      pc->data[j] = pc->data[j+1]; 
    }
    pc->sz--; //???pc->sz--
    printf("??????\n");
    PrintContact(pc);
  }
}

//????????????
void SearchContact(contact* pc)
{
  assert(pc);
  char name[NAME_MAX];

  if(pc->sz == 0) //pc->sz?????????м??????????0???????????????????????ж????????
  {
    printf("???????????????\n");
    return;
  }

  printf("???????????????????");
  scanf("%s", name);
  int pos = Find_Name(pc, name);
  //????????±?????????-1
  if (pos == -1)
    printf("δ?????????????????\n");
  else {
    printf("?????????????????\n");
    printf("%-10s %-5s %-6s %-12s %-15s\n", "????", "????", "???", "?绰", "???");
    printf("%-10s %-5d %-6s %-12s %-15s\n", 
      pc->data[pos].name, 
      pc->data[pos].age,
      pc->data[pos].sex,
      pc->data[pos].tele,
      pc->data[pos].address);
  }
}

//????????
void ModContact(contact* pc)
{
  assert(pc);
  char name[NAME_MAX];

  if(pc->sz == 0) //????????????????
  {
    printf("???????????????\n");
    return;
  }

  printf("?????????????????????");
  scanf("%s", name);
  int pos = Find_Name(pc, name);
  if (pos == -1)
    printf("δ??????????????????????????????\n");
  else {
    printf("????????????????????????????????????????\n");
    printf("????????????");              //???????????????????????????pos?Find_Name??????????
    scanf("%s", pc->data[pos].name);
    printf("??????????");
    scanf("%d", &pc->data[pos].age);
    printf("?????????");
    scanf("%s", pc->data[pos].sex);
    printf("?????????");
    scanf("%s", pc->data[pos].tele);
    printf("??????????");
    scanf("%s", pc->data[pos].address); 
    printf("??????");
    //?????????PrintContact()??????????
    PrintContact(pc);
  }
}

//????????
//?????????????????????????????????????????????????memset??????data???????????????????100??struct PeoInfo?????????С?????0??
void EmptyContact(contact* pc)
{
  assert(pc);
  char q = 0;
  printf("????????????????????(Y/N)\n"); //????????????????????????????
  /*getchar()???????
  ?????????????7??????????????????????????????????????????7??????
  ??????getchar()?????????scanf????? ?????????????? ??%c???????????????????????????????????else???
  getchar()????? ?????????????? ???????
  */
  getchar(); 
  scanf("%c", &q);
  if (q == 'Y')
  {
    memset(pc->data, 0, sizeof(pc->data)); //
    pc->sz = 0;
    printf("???????????????????\n");
    //?????????PrintContact()??????????
    PrintContact(pc);
  }
  else
  {
    printf("???????????????\n");
    return;
  }
    
}

//????????????????????
//??????
int mycomp(const void * p1, const void * p2)  /*?ú??????????????????????????????????????*/
{
  /*???????д???????peoInfo?????????(???????)????name????*/
  /*??????????????*/
  const peoInfo * a1 = (const peoInfo *) p1;
  const peoInfo * a2 = (const peoInfo *) p2;
  int res;
  res = strcmp(((peoInfo *)p1)->name,  ((peoInfo *)p2)->name);
  return (res); 
  //return (((peoInfo *)p1)->name,  ((peoInfo *)p2)->name); 
  //return strcmp( (*(peoInfo *)p1).name,  (*(peoInfo *)p2).name);
  
}

void SortContact(contact* pc)
{
  assert(pc);
  qsort(pc->data, pc->sz, sizeof(peoInfo), mycomp); 
  printf("???????\n");
  PrintContact(pc);
}


/*
void SortContact(contact* pc)
{
  assert(pc);
  qsort(pc->data, pc->sz, sizeof(pc->data[0]), mycomp); //sizeof(pc->data[0])????????????????????С??????????λ????sizeof(pc->data)???????????С??????????λ??
  printf("???????\n");
  PrintContact(pc);
}
*/

void DestroyContact(contact * pc)
{
 //?????
    free(pc->data);
    //??0/NULL
    pc->data = NULL;
    pc->sz = 0;
    pc->capacity = 0;
}